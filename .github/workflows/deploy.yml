name: Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  RUST_VERSION: "1.70"
  # Teleportの設定
  TELEPORT_PROXY: teleport.localhouse.jp:443
  TELEPORT_AUTH_TOKEN: github-token  # token.yamlで定義した名前
  DEPLOY_SERVER: ct108               # Teleport上のノード名
  DEPLOY_PATH: Projects

jobs:
  # mainにマージされたブランチがreleaseかチェック
  check-release:
    runs-on: ubuntu-latest
    outputs:
      should_deploy: ${{ steps.check.outputs.should_deploy }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Check if merge from release branch
        id: check
        run: |
          COMMIT_MSG=$(git log -1 --pretty=%B)
          echo "Commit message: $COMMIT_MSG"

          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "should_deploy=true" >> $GITHUB_OUTPUT
            echo "Manual deployment triggered"
          elif echo "$COMMIT_MSG" | grep -qE "Merge.*release"; then
            echo "should_deploy=true" >> $GITHUB_OUTPUT
            echo "Release branch merged, will deploy"
          else
            echo "should_deploy=false" >> $GITHUB_OUTPUT
            echo "Not a release merge, skipping deployment"
          fi

  deploy:
    needs: check-release
    if: needs.check-release.outputs.should_deploy == 'true'
    runs-on: ubuntu-latest

    # OIDC認証に必須の権限設定
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: ${{ env.RUST_VERSION }}

      - name: Build release binary
        run: |
          cargo build --release --bin umaibou-monster-game-server
          chmod +x target/release/umaibou-monster-game-server

      # Teleportのセットアップ (バージョンはサーバーに合わせて調整推奨)
      - name: Install Teleport
        uses: teleport-actions/setup@v1
        with:
          version: 16.4.7

      # Teleport OIDC認証 (Machine ID)
      - name: Authenticate with Teleport
        uses: teleport-actions/auth@v2
        with:
          proxy: ${{ env.TELEPORT_PROXY }}
          token: ${{ env.TELEPORT_AUTH_TOKEN }}
          certificate-ttl: 1h
          anonymous-telemetry: 0

      - name: Deploy to server
        run: |
          chmod +x scripts/deploy.sh
          scripts/deploy.sh
        env:
          DEPLOY_SERVER: ${{ env.DEPLOY_SERVER }}
          DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
          DEPLOY_PATH: ${{ env.DEPLOY_PATH }}

      - name: Verify deployment
        run: |
          # sshコマンドがそのまま使えるようになっている
          ssh ${{ secrets.DEPLOY_USER }}@${{ env.DEPLOY_SERVER }} "pgrep -f umaibou-monster-game-server && echo 'Service is running'"
