name: Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:  # 手動実行も可能に

env:
  RUST_VERSION: "1.70"
  TELEPORT_VERSION: "14.3.0"

jobs:
  # mainにマージされたブランチがreleaseかチェック
  check-release:
    runs-on: ubuntu-latest
    outputs:
      should_deploy: ${{ steps.check.outputs.should_deploy }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Check if merge from release branch
        id: check
        run: |
          # 直前のコミットメッセージを確認
          COMMIT_MSG=$(git log -1 --pretty=%B)
          echo "Commit message: $COMMIT_MSG"

          # workflow_dispatchの場合は常にデプロイ
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "should_deploy=true" >> $GITHUB_OUTPUT
            echo "Manual deployment triggered"
          # releaseブランチからのマージをチェック
          elif echo "$COMMIT_MSG" | grep -qE "Merge.*release"; then
            echo "should_deploy=true" >> $GITHUB_OUTPUT
            echo "Release branch merged, will deploy"
          else
            echo "should_deploy=false" >> $GITHUB_OUTPUT
            echo "Not a release merge, skipping deployment"
          fi

  deploy:
    needs: check-release
    if: needs.check-release.outputs.should_deploy == 'true'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: ${{ env.RUST_VERSION }}

      - name: Build release binary
        run: |
          cargo build --release --bin umaibou-monster-game-server
          chmod +x target/release/umaibou-monster-game-server

      - name: Install Teleport
        run: |
          curl -O https://cdn.teleport.dev/teleport-v${{ env.TELEPORT_VERSION }}-linux-amd64-bin.tar.gz
          tar -xzf teleport-v${{ env.TELEPORT_VERSION }}-linux-amd64-bin.tar.gz
          sudo mv teleport/tsh /usr/local/bin/
          sudo mv teleport/tctl /usr/local/bin/
          tsh version

      - name: Configure Teleport Machine ID
        run: |
          # Teleport Machine ID用のディレクトリ作成
          mkdir -p ~/.tsh

          # トークンをファイルに保存
          echo "${{ secrets.TELEPORT_TOKEN }}" > /tmp/teleport-token

          # Teleportにログイン
          tsh login \
            --proxy=teleport.localhouse.jp:443 \
            --auth=token \
            --token=$(cat /tmp/teleport-token) \
            --user=github-actions

          # トークンファイルを削除
          rm /tmp/teleport-token

      - name: Deploy to server
        run: |
          chmod +x scripts/deploy.sh
          scripts/deploy.sh
        env:
          DEPLOY_SERVER: ct108
          DEPLOY_NODE: CT108
          DEPLOY_PATH: Projects
          DEPLOY_USER: ${{ secrets.DEPLOY_USER }}

      - name: Verify deployment
        run: |
          # サーバーでアプリケーションが実行中か確認
          tsh ssh ${{ secrets.DEPLOY_USER }}@ct108 "pgrep -f umaibou-monster-game-server && echo 'Service is running' || echo 'Service is not running'"

      - name: Cleanup
        if: always()
        run: |
          # Teleportセッションをクリーンアップ
          tsh logout || true
