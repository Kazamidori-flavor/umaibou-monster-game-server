name: Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  RUST_VERSION: "1.89"
  TELEPORT_VERSION: "14.3.0"
  TELEPORT_PROXY: teleport.localhouse.jp:443
  DEPLOY_SERVER: ct108
  DEPLOY_PATH: Projects

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: ${{ env.RUST_VERSION }}

      - name: Build release binary
        run: |
          cargo build --release --bin umaibou-monster-game-server
          chmod +x target/release/umaibou-monster-game-server

      - name: Install Teleport
        run: |
          curl -O https://cdn.teleport.dev/teleport-v${{ env.TELEPORT_VERSION }}-linux-amd64-bin.tar.gz
          tar -xzf teleport-v${{ env.TELEPORT_VERSION }}-linux-amd64-bin.tar.gz
          sudo mv teleport/tsh /usr/local/bin/
          tsh version

      - name: Setup Teleport Identity
        run: |
          # Identity FileをSecretsから復元
          echo "${{ secrets.TELEPORT_IDENTITY }}" > auth.pem
          chmod 600 auth.pem

          # Identity fileのパスを絶対パスで取得
          echo "TELEPORT_IDENTITY_FILE=$(pwd)/auth.pem" >> $GITHUB_ENV

      - name: Verify Teleport connection
        run: |
          # Identity Fileを使って接続確認（実際のSSH接続テスト）
          tsh -i ${{ env.TELEPORT_IDENTITY_FILE }} ssh ${{ secrets.DEPLOY_USER }}@${{ env.DEPLOY_SERVER }} "echo 'Teleport connection successful'"

      - name: Deploy to server
        run: |
          chmod +x scripts/deploy.sh
          scripts/deploy.sh
        env:
          DEPLOY_SERVER: ${{ env.DEPLOY_SERVER }}
          DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
          DEPLOY_PATH: ${{ env.DEPLOY_PATH }}
          TELEPORT_IDENTITY_FILE: ${{ env.TELEPORT_IDENTITY_FILE }}

      - name: Verify deployment
        run: |
          tsh -i ${{ env.TELEPORT_IDENTITY_FILE }} ssh ${{ secrets.DEPLOY_USER }}@${{ env.DEPLOY_SERVER }} "pgrep -f umaibou-monster-game-server && echo 'Service is running'"

      - name: Cleanup
        if: always()
        run: |
          rm -f auth.pem
          tsh logout || true
